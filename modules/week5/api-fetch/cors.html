<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CORS | MAD9022</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="Fullstack: Frontend Development Course">
    
    <link rel="preload" href="/W2022/assets/css/0.styles.e8f982fe.css" as="style"><link rel="preload" href="/W2022/assets/js/app.86fc79ff.js" as="script"><link rel="preload" href="/W2022/assets/js/2.644458f3.js" as="script"><link rel="preload" href="/W2022/assets/js/4.e2498dd6.js" as="script"><link rel="preload" href="/W2022/assets/js/10.e0709425.js" as="script"><link rel="prefetch" href="/W2022/assets/js/11.03dd7ca9.js"><link rel="prefetch" href="/W2022/assets/js/12.099d5a86.js"><link rel="prefetch" href="/W2022/assets/js/13.2bd6007b.js"><link rel="prefetch" href="/W2022/assets/js/14.e0a43227.js"><link rel="prefetch" href="/W2022/assets/js/15.092d6948.js"><link rel="prefetch" href="/W2022/assets/js/16.859f074a.js"><link rel="prefetch" href="/W2022/assets/js/17.75c09ace.js"><link rel="prefetch" href="/W2022/assets/js/18.a6e526dd.js"><link rel="prefetch" href="/W2022/assets/js/19.bb7ee112.js"><link rel="prefetch" href="/W2022/assets/js/20.97f8b97a.js"><link rel="prefetch" href="/W2022/assets/js/21.23d3ef6f.js"><link rel="prefetch" href="/W2022/assets/js/22.933a5f9c.js"><link rel="prefetch" href="/W2022/assets/js/23.4a816fa9.js"><link rel="prefetch" href="/W2022/assets/js/24.4b4b432d.js"><link rel="prefetch" href="/W2022/assets/js/25.cd556980.js"><link rel="prefetch" href="/W2022/assets/js/26.ba97292d.js"><link rel="prefetch" href="/W2022/assets/js/27.cd63cd1f.js"><link rel="prefetch" href="/W2022/assets/js/28.7c415eed.js"><link rel="prefetch" href="/W2022/assets/js/29.cfd0de32.js"><link rel="prefetch" href="/W2022/assets/js/3.bca6a9a1.js"><link rel="prefetch" href="/W2022/assets/js/30.914c8d51.js"><link rel="prefetch" href="/W2022/assets/js/31.7bc52ca8.js"><link rel="prefetch" href="/W2022/assets/js/32.e7e81d1c.js"><link rel="prefetch" href="/W2022/assets/js/33.b0178163.js"><link rel="prefetch" href="/W2022/assets/js/34.849cc443.js"><link rel="prefetch" href="/W2022/assets/js/35.37fdb7ab.js"><link rel="prefetch" href="/W2022/assets/js/36.0c0d987a.js"><link rel="prefetch" href="/W2022/assets/js/37.be9d0dcc.js"><link rel="prefetch" href="/W2022/assets/js/38.1c08ef56.js"><link rel="prefetch" href="/W2022/assets/js/39.10bff2ae.js"><link rel="prefetch" href="/W2022/assets/js/40.8fe54bd5.js"><link rel="prefetch" href="/W2022/assets/js/41.42838ccb.js"><link rel="prefetch" href="/W2022/assets/js/42.241ccad7.js"><link rel="prefetch" href="/W2022/assets/js/43.458ecccd.js"><link rel="prefetch" href="/W2022/assets/js/44.07fdfe33.js"><link rel="prefetch" href="/W2022/assets/js/45.2da207c2.js"><link rel="prefetch" href="/W2022/assets/js/46.51fffa86.js"><link rel="prefetch" href="/W2022/assets/js/47.65aed37a.js"><link rel="prefetch" href="/W2022/assets/js/5.02d60a9c.js"><link rel="prefetch" href="/W2022/assets/js/6.40785f8b.js"><link rel="prefetch" href="/W2022/assets/js/7.c2b7ff19.js"><link rel="prefetch" href="/W2022/assets/js/8.c8690475.js"><link rel="prefetch" href="/W2022/assets/js/9.ec48c5f9.js">
    <link rel="stylesheet" href="/W2022/assets/css/0.styles.e8f982fe.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/W2022/" class="home-link router-link-active"><!----> <span class="site-name">MAD9022</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/W2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2022/assignments/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/W2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2022/assignments/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Introduction</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/W2022/overview/" class="sidebar-link">Overview</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Content Modules</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deliverables</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h1> <h2 id="what-is-a-domain-or-origin"><a href="#what-is-a-domain-or-origin" class="header-anchor">#</a> What is a Domain or Origin?</h2> <p>A <code>domain</code> refers to the name we give to a webserver's ip address. We could be talking about anything on specific computer or a specific folder on a specific computer. <code>example.com</code> is a domain name. he <code>.com</code> part is called the super domain. We can also add a subdomain like <code>www</code> in front of the domain to get <code>www.example.com</code>. This would be called a Full qualified domain name.</p> <div title="parts of the url" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/3ytQJvqzKu8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <p>An <code>origin</code> refers to a domain name PLUS a protocol, like <code>https:</code> and a port number. Eg: <code>:80</code>. All together the origin would look like this - <code>https://www.example.com:80</code>. That is an origin.</p> <p>When an HTML file is loaded by a user-agent , typically a browser, the origin of that HTML file defines the <code>origin</code> for everything else that happens on a webpage.</p> <p><img src="/W2022/assets/img/screen-1-same-domain.61c6731e.gif" alt="same origin"></p> <p>In this image we are seeing a fetch request for <code>application/json</code> data being sent from the script that is being run from the origin <code>https://www.mywebsite.com</code>. The <code>GET</code> request is being sent to <code>https://api.mywebsite.com</code>. The protocol, ports, and domain names match so the response is allowed and the script is able to display the data on the page.</p> <h2 id="what-does-cross-origin-mean"><a href="#what-does-cross-origin-mean" class="header-anchor">#</a> What Does Cross-Origin Mean?</h2> <p>The browser downloads and reads the HTML file looking for other assets to load. If any of those assets come from a different <code>origin</code> than the HTML file, then we are talking about a cross-origin request.</p> <p>If the browser is making a simple request for assets that will be displayed directly on the page with no client-side processing then we are allowed.</p> <p>If we are using JavaScript to get the asset, this opens up the possibility of malicious data interacting with your script and gaining access to user data. Now our <code>cross-origin</code> request can be intercepted by the browser based on the <code>same-origin</code> policy.</p> <p><img src="/W2022/assets/img/screen-2-cross-origin.d0d280fa.gif" alt="cross-origin"></p> <p>In this second example, we are making the request from <code>https://anotherwebsite.com</code>. The origins are different so the the <code>same-origin</code> policy kicks in and says no.</p> <p><img src="/W2022/assets/img/computer-says-no.8060afc9.gif" alt="computer says no"></p> <h2 id="bad-ports"><a href="#bad-ports" class="header-anchor">#</a> Bad Ports</h2> <p>It is worth noting that while you can generally make <code>fetch</code> requests to your server and respond to them over any port that you want, there are some that are considered <strong>BAD</strong>.</p> <p>If the <code>port</code> you are using appears in this list then your <code>fetch</code> call will be denied by the browser.</p> <table><thead><tr><th style="text-align:left;">Port</th> <th style="text-align:left;">Typical service</th></tr></thead> <tbody><tr><td style="text-align:left;">1</td> <td style="text-align:left;">tcpmux</td></tr> <tr><td style="text-align:left;">7</td> <td style="text-align:left;">echo</td></tr> <tr><td style="text-align:left;">9</td> <td style="text-align:left;">discard</td></tr> <tr><td style="text-align:left;">11</td> <td style="text-align:left;">systat</td></tr> <tr><td style="text-align:left;">13</td> <td style="text-align:left;">daytime</td></tr> <tr><td style="text-align:left;">15</td> <td style="text-align:left;">netstat</td></tr> <tr><td style="text-align:left;">17</td> <td style="text-align:left;">qotd</td></tr> <tr><td style="text-align:left;">19</td> <td style="text-align:left;">chargen</td></tr> <tr><td style="text-align:left;">20</td> <td style="text-align:left;">ftp-data</td></tr> <tr><td style="text-align:left;">21</td> <td style="text-align:left;">ftp</td></tr> <tr><td style="text-align:left;">22</td> <td style="text-align:left;">ssh</td></tr> <tr><td style="text-align:left;">23</td> <td style="text-align:left;">telnet</td></tr> <tr><td style="text-align:left;">25</td> <td style="text-align:left;">smtp</td></tr> <tr><td style="text-align:left;">37</td> <td style="text-align:left;">time</td></tr> <tr><td style="text-align:left;">42</td> <td style="text-align:left;">name</td></tr> <tr><td style="text-align:left;">43</td> <td style="text-align:left;">nicname</td></tr> <tr><td style="text-align:left;">53</td> <td style="text-align:left;">domain</td></tr> <tr><td style="text-align:left;">69</td> <td style="text-align:left;">tftp</td></tr> <tr><td style="text-align:left;">77</td> <td style="text-align:left;">—</td></tr> <tr><td style="text-align:left;">79</td> <td style="text-align:left;">finger</td></tr> <tr><td style="text-align:left;">87</td> <td style="text-align:left;">—</td></tr> <tr><td style="text-align:left;">95</td> <td style="text-align:left;">supdup</td></tr> <tr><td style="text-align:left;">101</td> <td style="text-align:left;">hostname</td></tr> <tr><td style="text-align:left;">102</td> <td style="text-align:left;">iso-tsap</td></tr> <tr><td style="text-align:left;">103</td> <td style="text-align:left;">gppitnp</td></tr> <tr><td style="text-align:left;">104</td> <td style="text-align:left;">acr-nema</td></tr> <tr><td style="text-align:left;">109</td> <td style="text-align:left;">pop2</td></tr> <tr><td style="text-align:left;">110</td> <td style="text-align:left;">pop3</td></tr> <tr><td style="text-align:left;">111</td> <td style="text-align:left;">sunrpc</td></tr> <tr><td style="text-align:left;">113</td> <td style="text-align:left;">auth</td></tr> <tr><td style="text-align:left;">115</td> <td style="text-align:left;">sftp</td></tr> <tr><td style="text-align:left;">117</td> <td style="text-align:left;">uucp-path</td></tr> <tr><td style="text-align:left;">119</td> <td style="text-align:left;">nntp</td></tr> <tr><td style="text-align:left;">123</td> <td style="text-align:left;">ntp</td></tr> <tr><td style="text-align:left;">135</td> <td style="text-align:left;">epmap</td></tr> <tr><td style="text-align:left;">137</td> <td style="text-align:left;">netbios-ns</td></tr> <tr><td style="text-align:left;">139</td> <td style="text-align:left;">9 netbios-ssn</td></tr> <tr><td style="text-align:left;">143</td> <td style="text-align:left;">imap</td></tr> <tr><td style="text-align:left;">161</td> <td style="text-align:left;">snmp</td></tr> <tr><td style="text-align:left;">179</td> <td style="text-align:left;">bgp</td></tr> <tr><td style="text-align:left;">389</td> <td style="text-align:left;">ldap</td></tr> <tr><td style="text-align:left;">427</td> <td style="text-align:left;">svrloc</td></tr> <tr><td style="text-align:left;">465</td> <td style="text-align:left;">submissions</td></tr> <tr><td style="text-align:left;">512</td> <td style="text-align:left;">exec</td></tr> <tr><td style="text-align:left;">513</td> <td style="text-align:left;">login</td></tr> <tr><td style="text-align:left;">514</td> <td style="text-align:left;">shell</td></tr> <tr><td style="text-align:left;">515</td> <td style="text-align:left;">print err</td></tr> <tr><td style="text-align:left;">526</td> <td style="text-align:left;">tempo</td></tr> <tr><td style="text-align:left;">530</td> <td style="text-align:left;">courier</td></tr> <tr><td style="text-align:left;">531</td> <td style="text-align:left;">chat</td></tr> <tr><td style="text-align:left;">532</td> <td style="text-align:left;">netnews</td></tr> <tr><td style="text-align:left;">540</td> <td style="text-align:left;">uucp</td></tr> <tr><td style="text-align:left;">548</td> <td style="text-align:left;">afp</td></tr> <tr><td style="text-align:left;">554</td> <td style="text-align:left;">rtsp</td></tr> <tr><td style="text-align:left;">556</td> <td style="text-align:left;">remotefs</td></tr> <tr><td style="text-align:left;">563</td> <td style="text-align:left;">nntps</td></tr> <tr><td style="text-align:left;">587</td> <td style="text-align:left;">submission</td></tr> <tr><td style="text-align:left;">601</td> <td style="text-align:left;">syslog-conn</td></tr> <tr><td style="text-align:left;">636</td> <td style="text-align:left;">ldaps</td></tr> <tr><td style="text-align:left;">993</td> <td style="text-align:left;">imaps</td></tr> <tr><td style="text-align:left;">995</td> <td style="text-align:left;">pop3s</td></tr> <tr><td style="text-align:left;">1719</td> <td style="text-align:left;">h323 gatestat</td></tr> <tr><td style="text-align:left;">1720</td> <td style="text-align:left;">h323 hostcall</td></tr> <tr><td style="text-align:left;">1723</td> <td style="text-align:left;">pptp</td></tr> <tr><td style="text-align:left;">2049</td> <td style="text-align:left;">nfs</td></tr> <tr><td style="text-align:left;">3659</td> <td style="text-align:left;">apple-sasl</td></tr> <tr><td style="text-align:left;">4045</td> <td style="text-align:left;">npp</td></tr> <tr><td style="text-align:left;">5060</td> <td style="text-align:left;">sip</td></tr> <tr><td style="text-align:left;">5061</td> <td style="text-align:left;">sips</td></tr> <tr><td style="text-align:left;">6000</td> <td style="text-align:left;">x11</td></tr> <tr><td style="text-align:left;">6566</td> <td style="text-align:left;">sane-port</td></tr> <tr><td style="text-align:left;">6665</td> <td style="text-align:left;">ircu</td></tr> <tr><td style="text-align:left;">6666</td> <td style="text-align:left;">ircu</td></tr> <tr><td style="text-align:left;">6667</td> <td style="text-align:left;">ircu</td></tr> <tr><td style="text-align:left;">6668</td> <td style="text-align:left;">ircu</td></tr> <tr><td style="text-align:left;">6669</td> <td style="text-align:left;">ircu</td></tr> <tr><td style="text-align:left;">6697</td> <td style="text-align:left;">ircs-u</td></tr></tbody></table> <h2 id="same-origin-policy"><a href="#same-origin-policy" class="header-anchor">#</a> Same-Origin Policy</h2> <p>The <code>same-origin</code> policy is implemented by all modern browsers and has been for years. You would have to go back to IE 10, whose long term support has officially ended, to find a browser that doesn't implement the CORS <code>same-origin</code> policy.</p> <p><img src="/W2022/assets/img/screen-3-comparing.18548521.gif" alt="comparing origins"></p> <p><strong>Rule One</strong> in this policy is that if the <code>origin</code> of your HTML file is the same as the <code>origin</code> of the resource that you are requesting with <code>fetch()</code> then all is fine. Do whatever you want with the asset. Download it, parse it, process it, or display it on the page.</p> <p>The challenges and rules come when you need an image or JSON data from a different <code>origin</code>.</p> <h2 id="not-the-same-origin"><a href="#not-the-same-origin" class="header-anchor">#</a> NOT the same origin</h2> <p>When a request is NOT covered by the <code>same-origin</code> policy, that is when <strong>CORS</strong> kicks in.</p> <p>When we make a <code>fetch</code> call, we can add an options setting for <code>mode</code> and set it to <code>cors</code>. We are explicitly telling the browser that we intend to make a <code>CORS</code> request.</p> <p>Try running this following line in the browser dev console.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://cors-demo.glitch.me/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'cors'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>We will get an error message that says something like this:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Access to fetch at 'https://cors-demo.glitch.me/'
from origin 'https://www.example.com' has
been blocked by CORS policy:
No 'Access-Control-Allow-Origin' header is present
on the requested resource. If an opaque response
serves your needs, set the request's mode
to 'no-cors' to fetch the resource with CORS disabled.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>This error message is actually telling us how to fix the problem.</p> <h2 id="the-server-needs-to-help"><a href="#the-server-needs-to-help" class="header-anchor">#</a> The Server Needs to Help</h2> <p>The requested resource is missing an <code>Access-Control-Allow-Origin</code> header. The server needed to send us an HTTP Response which included that header and the value of that header needed to match the origin of our HTML file.</p> <p>Here is another fetch request that you can test in the console.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://cors-demo.glitch.me/allow-cors'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'cors'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>This one is to a different end point <code>/allow-cors</code>. The end point name is not important. What is important are the headers in the response.</p> <p>Open the network tab, find the request for the <code>/allow-cors</code> endpoint, and click on it. You should see the headers listed now. Scroll down to the Response Headers section. And you should see this:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>access-control-allow-origin: *
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>That is the wildcard character, meaning that ALL origins are allowed to request this resource.</p> <blockquote><p>Note: if a request requires credentials then there must be an exact match for the origin. The wildcard character is NOT acceptable.</p></blockquote> <p>Ever want to protect a JSON resource so it can only be used on your own website? Server-side, add this header to all responses so that it can only be accessed by your own domain.</p> <p>With a NodeJS server using Express, it would look something like this:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/my-resource'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'Access-control-allow-origin'</span><span class="token operator">:</span> <span class="token string">'https://example.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{&quot;API-KEY&quot;:&quot;123abcdef456&quot;}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Now, only requests that are coming from <code>https://example.com</code> would be allowed to open and view that data.</p> <p>These rules and steps may seem painful for developers to work around but there are real security risks that we are protecting our users from by the browser forcing us to follow the steps.</p> <h2 id="preflight-requests"><a href="#preflight-requests" class="header-anchor">#</a> Preflight Requests</h2> <p>When a browser has decided that you are not doing a <code>same-origin</code> request and it needs to do a CORS test, then it will make a <strong>preflight request</strong>.</p> <p>Basically, it is still a <code>fetch</code> request but it uses the <code>OPTIONS</code> method, a smaller set of headers, and NO data or encoded files are sent to or received from the server.</p> <p>The browser wants to know if it is allowed to talk to the server and request files of a specific <code>mime-type</code> from that origin, for its own current origin.</p> <h2 id="simple-requests"><a href="#simple-requests" class="header-anchor">#</a> Simple Requests</h2> <p>Once we are past the <code>same-origin</code> policy check the browser will next check to see if the Request is a <strong>simple request</strong>. A simple request will <strong>NOT</strong> trigger a pre-flight request.</p> <p>A request is simple if it:</p> <ol><li>Uses <code>GET</code>, <code>POST</code>, or <code>HEAD</code>.</li> <li>If headers are added by the script they are only these ones:</li></ol> <ul><li><code>Accept</code> * Safari has extra restrictions on values for this.</li> <li><code>Accept-Language</code> * Safari has extra restrictions on values for this.</li> <li><code>Content-Language</code> * Safari has extra restrictions on values for this.</li> <li><code>Content-Type</code></li></ul> <ol start="3"><li>If a <code>Content-Type</code> header was added, it only has one of these values:</li></ol> <ul><li><code>text/plain</code></li> <li><code>application/x-www-form-urlencoded</code></li> <li><code>multipart/form-data</code></li></ul> <ol start="4"><li>If using the old <code>XMLHttpRequest</code> object, there is no listener for the <code>upload</code> event.</li> <li>No <code>ReadableStream</code> object is added to the request.</li></ol> <p>So, again, if it is a Simple Request, there will be no pre-flight request and everything is allowed to proceed.</p> <h2 id="not-so-simple"><a href="#not-so-simple" class="header-anchor">#</a> Not So Simple</h2> <p>If the request is determined to NOT be a simple request then the preflight request is sent using the <code>OPTIONS</code> method.</p> <p>When the browser receive the response to the preflight request, it looks for the <code>access-control-allow-origin</code> header and compares it to your <code>origin</code> header.</p> <p>If the two do NOT match, then the <code>fetch</code> request is denied and you get the error message in the console, that we saw above.</p> <h2 id="other-access-control-headers"><a href="#other-access-control-headers" class="header-anchor">#</a> Other Access-Control- Headers</h2> <p>There are actually other <code>Headers</code> in the <code>Request</code> and the <code>Response</code> that start with <code>Access-Control-</code>.</p> <p>Here is an example of a preflight request and response.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>OPTIONS /doc HTTP/1.1
Host: bar.other
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.16; rv:71.0) Gecko/20100101 Firefox/81.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Connection: keep-alive
Origin: http://foo.example
Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-PINGOTHER, Content-Type

HTTP/1.1 204 No Content
Date: Mon, 29 Mar 2021 01:15:39 GMT
Server: Apache/2
Access-Control-Allow-Origin: https://foo.example
Access-Control-Allow-Methods: POST, GET, OPTIONS
Access-Control-Allow-Headers: X-PINGOTHER, Content-Type
Access-Control-Max-Age: 86400
Vary: Accept-Encoding, Origin
Keep-Alive: timeout=2, max=100
Connection: Keep-Alive
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>In the Request we are using <code>*-Request-Method</code> to explain what we want to do after the preflight. We are using <code>*-Request-Headers</code> to list the headers that we will be adding via Script to the actual request.</p> <p>In the Response we are getting <code>*-Allow-Origin</code> for the browser to compare to our <code>origin</code> header from the Request. We get <code>*-Allow-Methods</code> to say what the server is willing to accept for that endpoint. We get <code>*-Allow-Headers</code> to confirm that we are allowed to use those custom headers in our full request. And finally, we get <code>*-Max-Age</code> to say that this response will be valid for 86400 seconds (24 hours).</p> <p>There is also a <code>Access-Control-Allow-Credentials</code> Response header to indicate whether or not cookies and authentication information is being sent and received. See the <a href="#HTML-crossorigin-attribute">HTML crossorigin attribute notes</a> att the bottom of this page for an example of sending those credentials.</p> <p>If you want to send these credentials with your <code>fetch</code> request then add this to the options object in your fetch call. The value can be either <code>omit</code> or <code>include</code>. The default value is <code>omit</code>.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'cors'</span><span class="token punctuation">,</span>
  credentials<span class="token operator">:</span> <span class="token string">'include'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>You won't see a <code>credentials</code> header in your Request. If you set it to <code>include</code>, then you will see the <code>cookies</code> and <code>authentication</code> headers as required.</p></blockquote> <p>Another response header is <code>Access-Control-Expose-Headers</code> which is a list of custom headers that are not just allowed by the server, but ones that you are allowed to access through the Response with JavaScript.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Access-Control-Expose-Headers: X-My-Custom-Header, X-Another-Custom-Header
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>If we got this response in our preflight request then we <strong>would</strong> be able to do this.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'X-My-Custom-Header'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'X-Another-Custom-Header'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="request-modes-for-fetch-requests"><a href="#request-modes-for-fetch-requests" class="header-anchor">#</a> Request Modes for Fetch Requests</h2> <p>When making your <code>fetch</code> call we can set a <code>mode</code> option.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">POST</span><span class="token template-punctuation string">`</span></span>
  mode<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cors</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  credentials<span class="token operator">:</span> <span class="token string">'omit'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>You can define a mode for a fetch request such that only certain requests will resolve. The modes you can set are as follows:</p> <ul><li><code>navigate</code> You will see this value in the network tab of the browser dev tools. We cannot use this for a fetch because it means that the user-agent wants to replace the current document with the one being retrieved.</li> <li><code>same-origin</code> only succeeds for requests for assets on the same origin, all other requests will reject.</li> <li><code>cors</code> will allow requests for assets on the same-origin and other origins which return the appropriate CORs headers.</li> <li><code>cors-with-forced-preflight</code> will always perform a preflight check before making the actual request.</li> <li><code>no-cors</code> is intended to make requests to other origins that do not have CORS headers and result in an opaque response, but, this isn't possible in the window global scope at the moment.</li></ul> <h2 id="preflight-responses"><a href="#preflight-responses" class="header-anchor">#</a> Preflight Responses</h2> <p>If the browser gets to the point of sending a preflight request, when the response comes back from the server, then the primary requirement is this:</p> <p>The <code>origin</code> Request header value <strong>MUST</strong> match the value in the <code>Access-Control-Allow-Origin</code> Response header.</p> <p>If this does not happen then you will get that error.</p> <h2 id="what-is-an-opaque-response"><a href="#what-is-an-opaque-response" class="header-anchor">#</a> What is an Opaque Response</h2> <p>An opaque response is for a request made for a resource on a different origin that doesn't return CORS headers. With an opaque response we won't be able to read the data returned or view the status of the request, meaning we can't check if the request was successful or not.</p> <p>We get a response from the server. Just not a usable one.</p> <p>Did you fetch an image and you now want to put it into a <code>&lt;canvas&gt;</code> element? That means being able to access the actual data in the file. If you get an opaque response you would not be able to put the image into the <code>&lt;canvas&gt;</code>.</p> <h2 id="mime-type-failures"><a href="#mime-type-failures" class="header-anchor">#</a> Mime-Type Failures</h2> <p>Browsers can also do checks to see if the Response <code>Content-Type</code> header matches what the content appears to be. For example, if the <code>Content-Type</code> header says that the file is <code>text/plain</code> but it is clearly a binary file like an <code>image/png</code> then the browser can also reject the response.</p> <h2 id="summary-of-steps"><a href="#summary-of-steps" class="header-anchor">#</a> Summary of Steps</h2> <p>If your request:</p> <ol><li>Does Not meet the <code>same-origin</code> policy.</li> <li>Uses a port from the BAD PORT list.</li> <li>Does Not meet the Simple Request requirements.</li> <li>Does Not successfully complete a preflight request and match the <code>origin</code> with the <code>access-control-allow-origin</code>.</li> <li>Does not meet the requirements of the other <code>Access-Control-*</code> headers.</li> <li>Does not have a valid <code>Content-Type</code>.</li></ol> <p>Then...</p> <p><img src="/W2022/assets/img/youre-gonna-have-a-bad-time.d6242ce6.jpeg" alt="have a bad time"></p> <p>Since you made it this far, we should also talk about <a href="/W2022/modules/week5/api-fetch/corb.html">CORB</a>.</p> <h2 id="html-crossorigin-attribute"><a href="#html-crossorigin-attribute" class="header-anchor">#</a> HTML crossorigin attribute</h2> <p>While not directly connected with the CORS policy it is useful to discuss this attribute because it does have to do with <code>cross-origin</code> security.</p> <p>The crossorigin attribute, can be added to the <code>&lt;audio&gt;</code>, <code>&lt;img&gt;</code>, <code>&lt;link&gt;</code>, <code>&lt;script&gt;</code>, and <code>&lt;video&gt;</code> elements, to provide support for CORS, by defining how the element handles <code>cross-origin</code> requests, thereby enabling the configuration of the CORS requests for the element's fetched data. Depending on the element, the attribute can be a CORS settings attribute.</p> <p>The values for the attribute are <code>anonymous</code> or <code>use-credentials</code></p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>
  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://picsum.photos/id/1023/300/300<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>use-credentials<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sample image<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Adding this attribute to those elements lets you decide whether or not identifying information along with those requests that are being sent to different origins.</p> <p>If you needed to have a cookie set or other identifying information so that the server will allow you to get the asset, then you need to use the value &quot;use-credentials&quot;.</p> <div title="crossorigin attribute" class="video-player"><iframe width="560" height="315" src="https://www.youtube.com/embed/m6lsF8z0hKk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; fullscreen" allowfullscreen="allowfullscreen"></iframe></div> <h3 id="references"><a href="#references" class="header-anchor">#</a> References</h3> <ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener noreferrer">MDN reference guide for CORS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://fetch.spec.whatwg.org/" target="_blank" rel="noopener noreferrer">Official W3C spec for Fetch and CORS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://dev.to/lydiahallie/cs-visualized-cors-5b8h" target="_blank" rel="noopener noreferrer">Dev.to article about CORS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p><a href="/W2022/modules/week5/api-fetch/" class="router-link-active">Back to the Class 5.2 main page</a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/11/2022, 4:03:59 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/W2022/assets/js/app.86fc79ff.js" defer></script><script src="/W2022/assets/js/2.644458f3.js" defer></script><script src="/W2022/assets/js/4.e2498dd6.js" defer></script><script src="/W2022/assets/js/10.e0709425.js" defer></script>
  </body>
</html>
